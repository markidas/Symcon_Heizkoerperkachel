<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    /* quadratisch, kleiner, transparent */
    .tile {
      width: 200px; height: 200px;
      padding: 8px 10px;
      border-radius: 12px;
      background: transparent;
      box-shadow: none;
      color: #1A202C;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-align: center;
    }
    .mode { font-size: 12px; font-weight: 600; letter-spacing: .3px; text-transform: uppercase; color: #4A5568; }
    .ist  { font-size: 30px; font-weight: 700; line-height: 1; }
    .meta { font-size: 13px; color: #4A5568; }

    /* ¾-Kreis (unten offen), zentriert und kleiner */
    .gauge { width: 75%; }
    svg { width: 100%; height: auto; display:block; }
    .g-bg   { fill: none; stroke: #E2E8F0; stroke-width: 8; }
    .g-fill { fill: none; stroke: #3182CE; stroke-width: 8; stroke-linecap: round; transition: stroke-dasharray .25s ease; }
    .g-text { font-size: 12px; fill: #1A202C; font-weight: 600; }
  </style>
</head>
<body>
  <div class="tile">
    <!-- 1) Betriebsart -->
    <div id="mode" class="mode">–</div>

    <!-- 2) Ist / Soll in der Mitte -->
    <div id="ist" class="ist">–.–°C</div>
    <div class="meta">Soll: <b id="soll">–.–°C</b></div>

    <!-- 3) Stellgröße als ¾-Kreis, unten offen (zentriert) -->
    <div class="gauge" aria-label="Ventilöffnung">
      <svg viewBox="0 0 100 100">
        <circle class="g-bg"
                cx="50" cy="50" r="36"
                pathLength="360"
                stroke-dasharray="270 90"
                transform="rotate(135 50 50)"/>
        <circle id="gFill" class="g-fill"
                cx="50" cy="50" r="36"
                pathLength="360"
                stroke-dasharray="0 360"
                transform="rotate(135 50 50)"/>
        <!-- Prozent in der Mitte -->
        <text id="gPct" class="g-text" x="50" y="54" text-anchor="middle">–%</text>
      </svg>
    </div>

    <!-- +/- Buttons kompakt (optional: auskommentieren, falls nicht gewünscht) -->
    <div style="display:flex; gap:6px;">
      <button style="border:0;border-radius:8px;padding:4px 8px;cursor:pointer;background:#EDF2F7;" onclick="adjust(-0.5)">−</button>
      <button style="border:0;border-radius:8px;padding:4px 8px;cursor:pointer;background:#EDF2F7;" onclick="adjust( 0.5)">+</button>
    </div>
  </div>

  <script>
    function handleMessage(payload) {
      try { var d = (typeof payload === 'string') ? JSON.parse(payload) : payload; } catch(e) { return; }

      // Ist/Soll
      setText('ist',  fmtTemp(d.ist));
      setText('soll', fmtTemp(d.soll));

      // Betriebsart (String oder formatierter Wert)
      setText('mode', (d.mode != null && d.mode !== '') ? String(d.mode) : '–');

      // Stellgröße
      var stell = clamp(Number(d.stell ?? 0), 0, 100);
      setText('gPct', Math.round(stell) + '%');

      // Gauge füllen: 0..270 "Grad" (pathLength=360 → Gradangabe)
      var fillDeg = 270 * (stell / 100);
      var g = document.getElementById('gFill');
      g.setAttribute('stroke-dasharray', fillDeg + ' ' + (360 - fillDeg));
    }

    function setText(id, txt) { var el = document.getElementById(id); if (el) el.textContent = txt; }
    function fmtTemp(v) { return (v == null) ? '–.–°C' : (Number(v).toFixed(1).replace('.', ',') + '°C'); }
    function clamp(v, a, b){ return Math.min(b, Math.max(a, v)); }

    // Soll anpassen (nur wenn VarSoll Variablenaktion hat)
    function adjust(delta) {
      var s = document.getElementById('soll').textContent.replace('°C','').replace(',','.');
      var next = clamp(parseFloat(s || '20') + delta, 5, 30);
      requestAction('Setpoint', next);
    }

    // Initiale Daten holen (kein null übergeben)
    requestAction('Refresh', 0);
  </script>
</body>
</html>
