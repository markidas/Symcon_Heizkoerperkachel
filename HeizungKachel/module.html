<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    /* quadratisch, kompakt, transparenter Hintergrund */
    .tile{
      width: 200px; height: 200px;            /* bei Bedarf anpassen (z.B. 180px) */
      padding: 10px;
      border-radius: 12px;
      background: transparent;
      color: #1A202C;
      display: grid;
      grid-auto-rows: max-content;
      align-content: center;
      justify-items: center;
      gap: 8px;
      text-align: center;
    }
    .mode { font-size: 12px; font-weight: 600; letter-spacing: .3px; text-transform: uppercase; color: #4A5568; }
    .ist  { font-size: 30px; font-weight: 700; line-height: 1; }
    .meta { font-size: 13px; color: #4A5568; }
    .soll-val { font-weight: 700; }

    /* Slider schlank */
    .slider-wrap{ width: 100%; padding: 0 6px; }
    input[type="range"]{
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 6px; border-radius: 999px;
      background: #E2E8F0; outline: none;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none; appearance: none;
      width: 18px; height: 18px; border-radius: 50%;
      background: #3182CE; cursor: pointer; border: none;
    }
    input[type="range"]::-moz-range-thumb{
      width: 18px; height: 18px; border-radius: 50%;
      background: #3182CE; cursor: pointer; border: none;
    }

    .scale { display:flex; justify-content:space-between; width:100%; font-size:11px; color:#718096; margin-top:2px; }
  </style>
</head>
<body>
  <div class="tile">
    <!-- Betriebsart -->
    <div id="mode" class="mode">–</div>

    <!-- Ist/Soll Text -->
    <div id="ist" class="ist">–.–°C</div>
    <div class="meta">Soll: <span id="soll" class="soll-val">–.–°C</span></div>

    <!-- Schieberegler für Soll -->
    <div class="slider-wrap">
      <!-- min/max/step nach Wunsch anpassen -->
      <input id="sld" type="range" min="5" max="30" step="0.5" value="20"
             oninput="previewSetpoint(this.value)" onchange="commitSetpoint(this.value)">
      <div class="scale"><span>5°</span><span>30°</span></div>
    </div>
  </div>

  <script>
    function handleMessage(payload){
      try { var d = (typeof payload === 'string') ? JSON.parse(payload) : payload; } catch(e){ return; }

      // Ist/Soll anzeigen
      setText('ist',  fmtTemp(d.ist));
      setText('soll', fmtTemp(d.soll));

      // Slider-Position auf Soll setzen (falls vorhanden)
      var sld = document.getElementById('sld');
      if (d.soll != null && !isNaN(d.soll)) {
        var v = clamp(Number(d.soll), Number(sld.min), Number(sld.max));
        sld.value = v;
      }

      // Betriebsart
      setText('mode', (d.mode != null && String(d.mode).trim() !== '') ? String(d.mode) : '–');
    }

    function previewSetpoint(v){
      // Anzeige sofort aktualisieren, ohne sofort zu schreiben
      setText('soll', fmtTemp(v));
    }

    function commitSetpoint(v){
      // Wert an das Modul senden (setzt VarSoll via RequestAction)
      requestAction('Setpoint', parseFloat(v));
    }

    function setText(id, txt){ var el=document.getElementById(id); if(el) el.textContent=txt; }
    function fmtTemp(v){ return (v==null) ? '–.–°C' : (Number(v).toFixed(1).replace('.', ',') + '°C'); }
    function clamp(v,a,b){ return Math.min(b, Math.max(a, v)); }

    // Initial laden
    requestAction('Refresh', 0);
  </script>
</body>
</html>
