<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .tile{
    width:200px;height:200px;
    padding:8px 10px;background:transparent;color:inherit;
    display:grid;grid-auto-rows:max-content;align-content:center;justify-items:center;
    gap:4px; /* kleineres Gap => alles rückt zusammen */
    text-align:center
  }
  .row{display:flex;gap:10px;align-items:center;justify-content:center}
  .btn{border:1px solid rgba(0,0,0,.15);background:transparent;border-radius:8px;padding:4px 12px;cursor:pointer;color:inherit}
  .btn:active{transform:translateY(1px)}

  .arc{width:78%}
  svg{width:100%;height:auto;display:block}
  .bg{fill:none;stroke:currentColor;stroke-opacity:.15;stroke-width:8}
  .fg{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dasharray .15s ease}
  .knob{stroke:#fff;stroke-width:2}

  .txt-ist{fill:currentColor;font-weight:700}
  .txt-soll{fill:currentColor;font-weight:600;opacity:.9}

  /* Feinsteuerung der vertikalen Abstände unterhalb des Bogens */
  #mode{ margin-top:-4px; font-weight:600; opacity:.7; color:inherit }
  .row-buttons{ margin-top:-2px; } /* Ventil + +/- näher an den Bogen */
</style>
</head>
<body>
  <div id="tile" class="tile">
    <div class="arc" aria-label="Heizungsstatus">
      <svg id="arc" viewBox="0 0 100 100">
        <defs>
          <linearGradient id="arcGrad" gradientUnits="userSpaceOnUse"
                          x1="14" y1="50" x2="86" y2="50"
                          gradientTransform="rotate(135 50 50)">
            <stop id="gStop1" offset="0%"   stop-color="#3182CE"/>
            <stop id="gStop2" offset="100%" stop-color="#3182CE"/>
          </linearGradient>
        </defs>

        <circle id="ringBg" class="bg" cx="50" cy="50" r="36"
                pathLength="360" stroke-dasharray="270 90"
                transform="rotate(135 50 50)"></circle>

        <circle id="ringFg" class="fg" cx="50" cy="50" r="36"
                pathLength="360" stroke-dasharray="0 360"
                transform="rotate(135 50 50)" stroke="url(#arcGrad)"></circle>

        <circle id="knob" class="knob" cx="50" cy="14" r="4" />

        <!-- HÖHER positioniert -->
        <text id="txtIst"  class="txt-ist"  x="50" y="42" text-anchor="middle">–.–°C</text>
        <text id="txtSoll" class="txt-soll" x="50" y="54" text-anchor="middle">–.–°C</text>
      </svg>
    </div>

    <!-- Betriebsart (näher am Bogen) -->
    <div id="mode">–</div>

    <!-- Ventil + +/- Taster (näher am Bogen) -->
    <div class="row row-buttons">
      <button class="btn" id="btnMinus">−</button>
      <div id="stellText" style="opacity:.7;color:inherit">Ventil: –%</div>
      <button class="btn" id="btnPlus">+</button>
    </div>
  </div>

<script>
  // Schrittweite (+/-), fix (Min/Max entfallen)
  const STEP = 0.5;

  let state = {
    ist:null, soll:null, stell:0, mode:'',
    style:{ aw:8, fg1:'#3182CE', fg2:'#3182CE', bg:'currentColor', knob:'#3182CE', fs:1.0 },
    size:200, ARC_R:36
  };

  // === Responsive Sizing ===
  const tile = document.getElementById('tile');
  const ro = new ResizeObserver(entries => {
    const s = Math.min(tile.clientWidth, tile.clientHeight) || 200;
    state.size = s;
    applySizing();
  });
  ro.observe(tile);

  function applySizing(){
    const s  = state.size;
    const fs = Number(state.style?.fs ?? 1.0);

    // Schriftgrößen (Faktor hier anpassen, wenn "Betriebsart" größer/kleiner soll)
    setSvgFont('txtIst',  Math.round(s * 0.18 * fs));
    setSvgFont('txtSoll', Math.round(s * 0.11 * fs));
    document.getElementById('mode').style.fontSize      = (s * 0.065 * fs).toFixed(1) + 'px';  // <— HIER die Betriebsart-Größe
    document.getElementById('stellText').style.fontSize = (s * 0.06  * fs).toFixed(1) + 'px';

    // Bogenbreite proportional (ArcWidth ist Basis bei 200px)
    const base = Number(state.style?.aw ?? 8);
    const aw = Math.max(2, base * (s/200));
    document.querySelectorAll('.bg').forEach(el => el.style.strokeWidth = aw+'px');
    document.querySelectorAll('.fg').forEach(el => el.style.strokeWidth = aw+'px');

    // Knopfgröße passend zur Bogenbreite
    document.getElementById('knob').setAttribute('r', Math.max(3, Math.round(aw*0.55)));
  }

  function setSvgFont(id, px){
    const el = document.getElementById(id);
    if (el) el.setAttribute('font-size', String(px));
  }

  // === Daten vom Modul ===
  function handleMessage(payload){
    try{ var d = (typeof payload==='string')? JSON.parse(payload) : payload; } catch(e){ return; }

    // Style übernehmen
    if (d.style){
      state.style.aw   = Number(d.style.aw  ?? state.style.aw);
      state.style.fg1  = String(d.style.fg1 ?? state.style.fg1);
      state.style.fg2  = String(d.style.fg2 ?? state.style.fg2);
      state.style.bg   = String(d.style.bg  ?? state.style.bg);
      state.style.knob = String(d.style.knob?? state.style.knob);
      state.style.fs   = Number(d.style.fs  ?? state.style.fs);
      applyDesign();
    }

    // Werte
    state.ist   = toNum(d.ist);
    state.soll  = toNum(d.soll);
    state.stell = clamp(toNum(d.stell) ?? 0, 0, 100);
    state.mode  = (d.mode!=null)? String(d.mode) : '';

    // Texte
    setTextSVG('txtIst',  fmtTemp(state.ist));
    setTextSVG('txtSoll', fmtTemp(state.soll));
    document.getElementById('mode').textContent = (state.mode && state.mode.trim()!=='') ? state.mode : '–';
    document.getElementById('stellText').textContent = 'Ventil: ' + (isFinite(state.stell) ? Math.round(state.stell)+'%' : '–%');

    // Bogen zeigt Stellgröße
    setArcFromStell(state.stell);

    applySizing();
  }

  function applyDesign(){
    document.querySelectorAll('.bg').forEach(el => el.style.stroke = state.style.bg);
    document.getElementById('gStop1').setAttribute('stop-color', state.style.fg1);
    document.getElementById('gStop2').setAttribute('stop-color', state.style.fg2);
    document.getElementById('knob').style.fill = state.style.knob || state.style.fg2;
  }

  const fill = document.getElementById('fill');
  const knob = document.getElementById('knob');
  function setArcFromStell(stell){
    const deg = clamp(270 * (stell/100), 0, 270);
    fill.setAttribute('stroke-dasharray', deg + ' ' + (360 - deg));
    const angle = (135 + deg) * Math.PI/180;
    const r = state.ARC_R; // Radius des Bogens
    const cx = 50 + r * Math.cos(angle), cy = 50 + r * Math.sin(angle);
    knob.setAttribute('cx', cx.toFixed(2));
    knob.setAttribute('cy', cy.toFixed(2));
  }

  // +/- Taster
  document.getElementById('btnMinus').onclick = ()=> nudgeSetpoint(-STEP);
  document.getElementById('btnPlus').onclick  = ()=> nudgeSetpoint(+STEP);

  function nudgeSetpoint(delta){
    const cur  = (state.soll!=null) ? Number(state.soll) : 20;
    const next = quantize(cur + delta, STEP);
    setTextSVG('txtSoll', fmtTemp(next)); // Vorschau
    requestAction('Setpoint', next);      // Schreiben
  }

  // Utils
  function setTextSVG(id, txt){ const el=document.getElementById(id); if (el) el.textContent=txt; }
  function toNum(v){ return (v==null || isNaN(v)) ? null : Number(v); }
  function clamp(v,a,b){ return Math.min(b, Math.max(a, v)); }
  function quantize(v, step){ if (!step||step<=0) return v; return Math.round(v/step)*step; }
  function fmtTemp(v){ return (v==null)? '–.–°C' : (Number(v).toFixed(1).replace('.', ',') + '°C'); }

  requestAction('Refresh', 0);
</script>
</body>
</html>
