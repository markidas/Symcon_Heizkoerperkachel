<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .tile{
    width:200px;height:200px;padding:8px 10px;border-radius:12px;background:transparent;color:#1A202C;
    display:grid;grid-auto-rows:max-content;align-content:center;justify-items:center;gap:6px;text-align:center
  }
  .mode{font-size:12px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;color:#4A5568}
  .ist{font-size:30px;font-weight:700;line-height:1}
  .meta{font-size:13px;color:#4A5568}
  .val{font-weight:700}

  .arc{width:78%}
  svg{width:100%;height:auto;display:block;touch-action:none}
  /* Default-Werte – werden von JS aus der Konfiguration überschrieben */
  .bg{fill:none;stroke:#E2E8F0;stroke-width:8}
  .fg{fill:none;stroke:#3182CE;stroke-width:8;stroke-linecap:round;transition:stroke-dasharray .15s ease}
  .knob{fill:#3182CE;stroke:#fff;stroke-width:2}
</style>
</head>
<body>
  <div class="tile">
    <div id="mode" class="mode">–</div>
    <div id="ist" class="ist">–.–°C</div>
    <div class="meta">Soll: <span id="soll" class="val">–.–°C</span></div>
    <div class="meta">Ventil: <span id="stell" class="val">–%</span></div>

    <div class="arc" aria-label="Solltemperatur einstellen">
      <svg id="arc" viewBox="0 0 100 100">
        <defs>
          <!-- Gradient für Vordergrund; Farben werden per JS gesetzt -->
          <linearGradient id="arcGrad" gradientUnits="userSpaceOnUse"
                          x1="14" y1="50" x2="86" y2="50"
                          gradientTransform="rotate(135 50 50)">
            <stop id="gStop1" offset="0%"   stop-color="#3182CE"/>
            <stop id="gStop2" offset="100%" stop-color="#3182CE"/>
          </linearGradient>
        </defs>
        <circle class="bg" cx="50" cy="50" r="36" pathLength="360" stroke-dasharray="270 90" transform="rotate(135 50 50)"></circle>
        <circle id="fill" class="fg" cx="50" cy="50" r="36" pathLength="360" stroke-dasharray="0 360" transform="rotate(135 50 50)" stroke="url(#arcGrad)"></circle>
        <circle id="knob" class="knob" cx="50" cy="14" r="4" />
      </svg>
    </div>
  </div>

<script>
  const SL_MIN = 5, SL_MAX = 30, SL_STEP = 0.5;
  let state = { soll:null, ist:null, stell:null, mode:null, dragging:false };

  function handleMessage(payload){
    try{ var d = (typeof payload==='string')? JSON.parse(payload) : payload; } catch(e){ return; }

    state.ist   = toNum(d.ist);
    state.soll  = toNum(d.soll);
    state.stell = toNum(d.stell);
    state.mode  = (d.mode!=null)? String(d.mode) : '';

    setText('ist',  fmtTemp(state.ist));
    setText('soll', fmtTemp(state.soll));
    setText('stell', (state.stell!=null? Math.round(state.stell)+'%' : '–%'));
    setText('mode', (state.mode && state.mode.trim()!=='') ? state.mode : '–');

    // === Design aus Konfiguration anwenden (überschreibt CSS per Inline-Style) ===
if (d.style){
  const aw  = Math.max(2, Number(d.style.aw || 8));
  const fg1 = (d.style.fg1 || '#3182CE');
  const fg2 = (d.style.fg2 || fg1);
  const bg  = (d.style.bg  || '#E2E8F0');

  // Bogenbreite & Hintergrundfarbe
  document.querySelectorAll('.bg').forEach(el => {
    el.style.strokeWidth = aw + 'px';
    el.style.stroke = bg;
  });

  document.querySelectorAll('.fg').forEach(el => {
    el.style.strokeWidth = aw + 'px';
    // Stroke kommt aus dem Verlauf, Stylebreite reicht hier
  });

  // Gradient-Farben für den sichtbaren Bogen
  document.getElementById('gStop1').setAttribute('stop-color', fg1);
  document.getElementById('gStop2').setAttribute('stop-color', fg2);

  // Knopf-Farbe an FG-Ende anlehnen (optional)
  document.getElementById('knob').style.fill = fg2;
}


    if (state.soll!=null) setArcFromValue(state.soll); else setArcFromValue(SL_MIN);
  }

  // Arc-Interaktion
  const svg  = document.getElementById('arc');
  const fill = document.getElementById('fill');
  const knob = document.getElementById('knob');

  svg.addEventListener('pointerdown', startDrag);
  window.addEventListener('pointermove', onDrag);
  window.addEventListener('pointerup', endDrag);

  function startDrag(e){ state.dragging = true; svg.setPointerCapture(e.pointerId); updateFromPointer(e); }
  function onDrag(e){ if (!state.dragging) return; updateFromPointer(e); }
  function endDrag(e){
    if (!state.dragging) return;
    state.dragging = false;
    svg.releasePointerCapture(e.pointerId);
    if (state.soll!=null) requestAction('Setpoint', state.soll);
  }

  function updateFromPointer(e){
    const rect = svg.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width ) * 100;
    const y = ((e.clientY - rect.top ) / rect.height) * 100;

    let ang = Math.atan2(y-50, x-50) * 180/Math.PI; if (ang < 0) ang += 360;
    let a = ang - 135; if (a < 0) a += 360;
    a = clamp(a, 0, 270);

    const t = a / 270;
    let val = SL_MIN + t * (SL_MAX - SL_MIN);
    val = quantize(val, SL_STEP);
    val = clamp(val, SL_MIN, SL_MAX);

    state.soll = val;
    setText('soll', fmtTemp(val));
    setArcFromValue(val);
  }

  function setArcFromValue(val){
    const t = (val - SL_MIN) / (SL_MAX - SL_MIN);
    const deg = clamp(270 * t, 0, 270);
    fill.setAttribute('stroke-dasharray', deg + ' ' + (360 - deg));

    const angle = (135 + deg) * Math.PI/180;
    const r = 36, cx = 50 + r * Math.cos(angle), cy = 50 + r * Math.sin(angle);
    knob.setAttribute('cx', cx.toFixed(2));
    knob.setAttribute('cy', cy.toFixed(2));
  }

  // Utils
  function setText(id, txt){ const el=document.getElementById(id); if (el) el.textContent=txt; }
  function fmtTemp(v){ return (v==null)? '–.–°C' : (Number(v).toFixed(1).replace('.', ',') + '°C'); }
  function toNum(v){ return (v==null || isNaN(v)) ? null : Number(v); }
  function clamp(v,a,b){ return Math.min(b, Math.max(a, v)); }
  function quantize(v, step){ if (!step || step<=0) return v; return Math.round(v/step)*step; }

  requestAction('Refresh', 0);
</script>
</body>
</html>
