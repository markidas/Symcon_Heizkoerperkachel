<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .tile{
    /* Breite/Höhe werden per JS aus CONFIG.tile.sizePx gesetzt */
    padding:8px 10px;background:transparent;color:inherit;
    display:grid;grid-auto-rows:max-content;align-content:center;justify-items:center;
    gap:4px;text-align:center
  }
  .row{display:flex;gap:10px;align-items:center;justify-content:center}
  .btn{border:1px solid currentColor;background:transparent;border-radius:8px;padding:4px 12px;cursor:pointer;color:inherit}
  .btn:active{transform:translateY(1px)}

  .arc{width:78%} /* wird durch CONFIG.arc.widthPct via JS überschrieben */
  svg{width:100%;height:auto;display:block}
  .bg{fill:none;stroke:currentColor;stroke-opacity:.15;stroke-width:8} /* JS überschreibt inline */
  .fg{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dasharray .15s ease} /* JS überschreibt inline */
  .knob{stroke:#fff;stroke-width:2}

  .txt-ist{fill:currentColor;font-weight:700}
  .txt-soll{fill:currentColor;font-weight:600}
</style>
</head>
<body>
  <div id="tile" class="tile">
    <div class="arc" aria-label="Heizungsstatus">
      <svg id="arc" viewBox="0 0 100 100">
        <defs>
          <linearGradient id="arcGrad" gradientUnits="userSpaceOnUse"
                          x1="14" y1="50" x2="86" y2="50"
                          gradientTransform="rotate(135 50 50)">
            <stop id="gStop1" offset="0%"   stop-color="#3182CE"/>
            <stop id="gStop2" offset="100%" stop-color="#3182CE"/>
          </linearGradient>
        </defs>

        <!-- ¾-Kreis (unten offen) -->
        <circle id="ringBg" class="bg" cx="50" cy="50" r="36"
                pathLength="360" stroke-dasharray="270 90"
                transform="rotate(135 50 50)"></circle>

        <!-- Füllung = Stellgröße -->
        <circle id="ringFg" class="fg" cx="50" cy="50" r="36"
                pathLength="360" stroke-dasharray="0 360"
                transform="rotate(135 50 50)" stroke="url(#arcGrad)"></circle>

        <!-- Punkt -->
        <circle id="knob" class="knob" cx="50" cy="14" r="4" />

        <!-- Zentrum: Ist / Soll (leicht nach oben) -->
        <text id="txtIst"  class="txt-ist"  x="50" y="42" text-anchor="middle">–.–°C</text>
        <text id="txtSoll" class="txt-soll" x="50" y="54" text-anchor="middle">–.–°C</text>
      </svg>
    </div>

    <!-- Betriebsart -->
    <div id="mode" style="font-weight:600">–</div>

    <!-- Ventil + +/- -->
    <div class="row">
      <button class="btn" id="btnMinus">−</button>
      <div id="stellText">Ventil: –%</div>
      <button class="btn" id="btnPlus">+</button>
    </div>
  </div>

<script>
/* =============================================================================
   KONFIG-BLOCK — hier ALLES einstellen
   ============================================================================= */
const CONFIG = {
  tile: { sizePx: 200 },     // Kachel-Kantenlänge in px (z.B. 180, 220, ...)
  arc:  {
    radius: 36,              // SVG-Radius (0–50 sinnvoll)
    widthBase: 8,            // Strichstärke bei tile.sizePx
    widthPct: 0.78           // Breite des Arc-Containers relativ zur Kachel
  },
  font: {
    scale: 1.0,              // globaler Faktor
    ist:  0.16,              // Anteile an Kachelkante
    soll: 0.095,
    mode: 0.055,             // Betriebsart
    info: 0.050              // „Ventil: xx%“
  },
  centerY: {                 // vertikale Positionen im SVG
    ist:  42,
    soll: 54
  },
  color: {
    useThemeText: true,      // Texte folgen Theme (currentColor)
    arcBg: 'currentColor',   // Hintergrundbogen-Farbe
    arcBgOpacity: 0.15,      // Transparenz nur wenn arcBg='currentColor'
    arcStart: '#3182CE',     // Verlauf Start (Füllbogen)
    arcEnd:   '#3182CE',     // Verlauf Ende
    knob:     '#3182CE'      // Punktfarbe
  },
  step: 0.5                  // Schrittweite der +/- Buttons (°C)
};
/* ==== ENDE KONFIG-BLOCK ==================================================== */

let state = { ist:null, soll:null, stell:0, mode:'', size:CONFIG.tile.sizePx };

const tile   = document.getElementById('tile');
const arcDiv = document.querySelector('.arc');
const ringBg = document.getElementById('ringBg');
const ringFg = document.getElementById('ringFg');
const fill   = document.getElementById('ringFg');
const knob   = document.getElementById('knob');

// Kachelgröße aus CONFIG setzen (kann in der Visu trotzdem frei skaliert werden)
function applyTileSize(){
  tile.style.width  = CONFIG.tile.sizePx + 'px';
  tile.style.height = CONFIG.tile.sizePx + 'px';
  state.size        = CONFIG.tile.sizePx;
}
applyTileSize();

// Responsiv: falls die Visualisierung die Kachel größer/kleiner macht
const ro = new ResizeObserver(() => {
  const s = Math.min(tile.clientWidth, tile.clientHeight);
  state.size = s || CONFIG.tile.sizePx;
  applySizing();
});
ro.observe(tile);

function applySizing(){
  const s  = state.size;
  const fs = CONFIG.font.scale;

  // Arc-Container-Breite
  arcDiv.style.width = (CONFIG.arc.widthPct * 100) + '%';

  // Schriften
  setSvgFont('txtIst',  Math.round(s * CONFIG.font.ist  * fs));
  setSvgFont('txtSoll', Math.round(s * CONFIG.font.soll * fs));
  document.getElementById('mode').style.fontSize      = (s * CONFIG.font.mode * fs).toFixed(1) + 'px';
  document.getElementById('stellText').style.fontSize = (s * CONFIG.font.info * fs).toFixed(1) + 'px';

  // Strichstärke proportional zur tatsächlichen Kachelgröße
  const aw = Math.max(2, CONFIG.arc.widthBase * (s / CONFIG.tile.sizePx));
  ringBg.style.strokeWidth = aw + 'px';
  ringFg.style.strokeWidth = aw + 'px';

  // Knopfgröße passend zur Bogenbreite
  knob.setAttribute('r', Math.max(3, Math.round(aw * 0.55)));
}

function setSvgFont(id, px){
  const el = document.getElementById(id);
  if (el) el.setAttribute('font-size', String(px));
}

function applyDesign(){
  // Radius setzen
  ringBg.setAttribute('r', CONFIG.arc.radius);
  ringFg.setAttribute('r', CONFIG.arc.radius);

  // Zentrumstexte positionieren
  document.getElementById('txtIst').setAttribute('y', String(CONFIG.centerY.ist));
  document.getElementById('txtSoll').setAttribute('y', String(CONFIG.centerY.soll));

  // Farben
  ringBg.style.stroke = CONFIG.color.arcBg;
  ringBg.style.strokeOpacity = (CONFIG.color.arcBg === 'currentColor')
    ? CONFIG.color.arcBgOpacity : 1;

  document.getElementById('gStop1').setAttribute('stop-color', CONFIG.color.arcStart);
  document.getElementById('gStop2').setAttribute('stop-color', CONFIG.color.arcEnd);
  knob.style.fill = CONFIG.color.knob;
}

// Daten vom Modul
function handleMessage(payload){
  try{ var d = (typeof payload==='string')? JSON.parse(payload) : payload; } catch(e){ return; }

  state.ist   = toNum(d.ist);
  state.soll  = toNum(d.soll);
  state.stell = clamp(toNum(d.stell) ?? 0, 0, 100);
  state.mode  = (d.mode!=null)? String(d.mode) : '';

  setTextSVG('txtIst',  fmtTemp(state.ist));
  setTextSVG('txtSoll', fmtTemp(state.soll));
  document.getElementById('mode').textContent      = (state.mode && state.mode.trim()!=='') ? state.mode : '–';
  document.getElementById('stellText').textContent = 'Ventil: ' + (isFinite(state.stell) ? Math.round(state.stell)+'%' : '–%');

  setArcFromStell(state.stell);
  applySizing();
}

// Bogen nach Stellgröße (0..100 %)
function setArcFromStell(stell){
  const deg = clamp(270 * (stell/100), 0, 270);
  fill.setAttribute('stroke-dasharray', deg + ' ' + (360 - deg));

  const angle = (135 + deg) * Math.PI/180;
  const r = CONFIG.arc.radius;
  const cx = 50 + r * Math.cos(angle), cy = 50 + r * Math.sin(angle);
  knob.setAttribute('cx', cx.toFixed(2));
  knob.setAttribute('cy', cy.toFixed(2));
}

// +/- Taster
document.getElementById('btnMinus').onclick = ()=> nudgeSetpoint(-CONFIG.step);
document.getElementById('btnPlus').onclick  = ()=> nudgeSetpoint(+CONFIG.step);
function nudgeSetpoint(dir){
  const cur  = (state.soll!=null) ? Number(state.soll) : 20;
  const next = quantize(cur + dir*CONFIG.step, CONFIG.step);
  setTextSVG('txtSoll', fmtTemp(next)); // Vorschau
  requestAction('Setpoint', next);      // Schreiben
}

// Utils
function setTextSVG(id, txt){ const el=document.getElementById(id); if (el) el.textContent=txt; }
function toNum(v){ return (v==null || isNaN(v)) ? null : Number(v); }
function clamp(v,a,b){ return Math.min(b, Math.max(a, v)); }
function quantize(v, step){ if (!step||step<=0) return v; return Math.round(v/step)*step; }
function fmtTemp(v){ return (v==null)? '–.–°C' : (Number(v).toFixed(1).replace('.', ',') + '°C'); }

// Start
applyDesign();
applyTileSize();
applySizing();
requestAction('Refresh', 0);
</script>
</body>
</html>
